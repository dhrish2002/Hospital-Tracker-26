<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ward Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e1117;
    --surface: #161b27;
    --surface2: #1d2535;
    --border: #2a3347;
    --accent: #4fffb0;
    --accent2: #ff6b6b;
    --text: #e8edf5;
    --muted: #6b7a99;
    --critical: #ff4d6d;
    --pending-color: #ffd166;
    --private-color: #c084fc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background-image: linear-gradient(rgba(79,255,176,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(79,255,176,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
  }
  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(14,17,23,0.93); backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 13px 26px; display: flex; align-items: center; justify-content: space-between; gap: 16px;
  }
  .logo { font-family: 'Fraunces', serif; font-size: 1.4rem; font-weight: 600; color: var(--accent); letter-spacing: -0.5px; white-space: nowrap; }
  .logo span { color: var(--muted); font-weight: 300; font-style: italic; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .header-meta { font-size: 0.68rem; color: var(--muted); text-align: right; line-height: 1.6; }
  .header-meta strong { color: var(--text); display: block; }
  .btn-header { display: flex; align-items: center; gap: 5px; padding: 7px 13px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.71rem; background: var(--surface2); color: var(--text); transition: all 0.15s; }
  .btn-header:hover { border-color: var(--accent); color: var(--accent); }
  main { position: relative; z-index: 1; padding: 26px; max-width: 1400px; margin: 0 auto; }
  .top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; flex-wrap: wrap; gap: 10px; }
  .legend { display: flex; align-items: center; gap: 14px; font-size: 0.66rem; color: var(--muted); flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 5px; }
  .flag { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .flag-pending { background: var(--pending-color); }
  .flag-critical { background: var(--critical); }
  .flag-discharge { background: var(--accent); }
  .flag-private { background: var(--private-color); }
  .ward-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)); gap: 16px; }
  .ward-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: border-color 0.2s; }
  .ward-card:hover { border-color: rgba(79,255,176,0.22); }
  .ward-header { padding: 11px 14px; background: var(--surface2); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .ward-header-left { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
  .ward-name { font-family: 'Fraunces', serif; font-size: 0.93rem; font-weight: 600; letter-spacing: -0.3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .ward-badge { font-size: 0.61rem; padding: 2px 7px; border-radius: 20px; white-space: nowrap; background: rgba(79,255,176,0.1); color: var(--accent); border: 1px solid rgba(79,255,176,0.2); }
  .ward-actions { display: flex; gap: 3px; }
  .icon-btn { background: none; border: none; cursor: pointer; color: var(--muted); padding: 3px 6px; border-radius: 6px; font-size: 0.74rem; transition: all 0.15s; display: flex; align-items: center; }
  .icon-btn:hover { background: var(--border); color: var(--text); }
  .icon-btn.danger:hover { background: rgba(255,77,109,0.14); color: var(--critical); }
  .patient-list { padding: 7px; display: flex; flex-direction: column; gap: 4px; }
  .patient-row { padding: 9px 10px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.02); }
  .patient-row:hover { background: rgba(79,255,176,0.06); border-color: rgba(79,255,176,0.18); }
  .patient-left { display: flex; align-items: center; gap: 8px; min-width: 0; }
  .patient-avatar { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.61rem; font-weight: 500; flex-shrink: 0; }
  .patient-name { font-size: 0.79rem; font-weight: 500; color: var(--text); line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
  .patient-bed { font-size: 0.62rem; color: var(--muted); margin-top: 2px; }
  .patient-right { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
  .patient-flags { display: flex; gap: 3px; align-items: center; }
  .private-badge-sm { font-size: 0.54rem; padding: 1px 5px; border-radius: 10px; background: rgba(192,132,252,0.14); color: var(--private-color); border: 1px solid rgba(192,132,252,0.28); white-space: nowrap; }
  .add-patient-btn { width: 100%; margin-top: 2px; padding: 7px; background: none; border: 1px dashed var(--border); border-radius: 8px; color: var(--muted); font-family: 'DM Mono', monospace; font-size: 0.7rem; cursor: pointer; transition: all 0.15s; }
  .add-patient-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(79,255,176,0.04); }

  /* MODALS */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.72); backdrop-filter: blur(4px); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.active { display: flex; animation: fadeIn 0.15s ease; }
  @keyframes fadeIn { from{opacity:0}to{opacity:1} }
  @keyframes slideUp { from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1} }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 700px; max-height: 92vh; overflow-y: auto; animation: slideUp 0.2s ease; }
  .modal.sm { max-width: 460px; }
  .modal-top { padding: 18px 22px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; justify-content: space-between; position: sticky; top: 0; background: var(--surface); z-index: 10; border-radius: 16px 16px 0 0; }
  .modal-title-row { display: flex; align-items: flex-start; gap: 10px; flex: 1; min-width: 0; }
  .modal-patient-name { font-family: 'Fraunces', serif; font-size: 1.35rem; font-weight: 600; letter-spacing: -0.5px; line-height: 1.1; }
  .modal-sub { font-size: 0.67rem; color: var(--muted); margin-top: 4px; }
  .private-badge { font-size: 0.63rem; padding: 3px 9px; border-radius: 12px; margin-top: 4px; white-space: nowrap; flex-shrink: 0; background: rgba(192,132,252,0.14); color: var(--private-color); border: 1px solid rgba(192,132,252,0.28); }
  .public-badge { font-size: 0.63rem; padding: 3px 9px; border-radius: 12px; margin-top: 4px; white-space: nowrap; flex-shrink: 0; background: rgba(79,255,176,0.1); color: var(--accent); border: 1px solid rgba(79,255,176,0.2); }
  .modal-top-actions { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
  .close-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); width: 29px; height: 29px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; transition: all 0.15s; }
  .close-btn:hover { background: var(--border); color: var(--text); }
  .edit-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); padding: 0 11px; height: 29px; border-radius: 8px; cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.67rem; display: flex; align-items: center; gap: 4px; transition: all 0.15s; }
  .edit-btn:hover { border-color: var(--accent); color: var(--accent); }
  .edit-btn.active { background: rgba(79,255,176,0.1); border-color: var(--accent); color: var(--accent); }
  .modal-body { padding: 18px 22px; display: flex; flex-direction: column; gap: 20px; }
  .section-label { font-size: 0.61rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 9px; display: flex; align-items: center; gap: 8px; }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .field-group { display: flex; flex-direction: column; gap: 5px; }
  .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  label.field-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.05em; }
  input[type="text"], input[type="number"], select, textarea.mta {
    width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 11px;
    font-family: 'DM Mono', monospace; font-size: 0.77rem; color: var(--text); outline: none; transition: border-color 0.15s; appearance: none;
  }
  input:focus, select:focus, textarea.mta:focus { border-color: rgba(79,255,176,0.38); }
  textarea.mta { resize: vertical; line-height: 1.6; }
  textarea.mta.dta { min-height: 100px; }
  select option { background: var(--surface2); }
  .diagnosis-block { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 13px; border-left: 3px solid var(--accent2); }
  .diagnosis-primary { font-size: 0.88rem; font-weight: 500; margin-bottom: 6px; }
  .diagnosis-details { font-size: 0.73rem; color: var(--muted); line-height: 1.6; }
  .task-list { display: flex; flex-direction: column; gap: 5px; }
  .task-item { display: flex; align-items: center; gap: 8px; padding: 8px 11px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; transition: all 0.15s; }
  .task-item.done { opacity: 0.44; }
  .task-checkbox { width: 16px; height: 16px; border-radius: 5px; border: 1.5px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; background: transparent; }
  .task-item.done .task-checkbox { background: var(--accent); border-color: var(--accent); }
  .task-checkbox::after { content: ''; display: none; }
  .task-item.done .task-checkbox::after { display: block; width: 4px; height: 8px; border: 2px solid var(--bg); border-top: none; border-left: none; transform: rotate(45deg) translateY(-1px); }
  .task-text { font-size: 0.75rem; color: var(--text); flex: 1; line-height: 1.4; }
  .task-item.done .task-text { text-decoration: line-through; color: var(--muted); }
  .task-priority { font-size: 0.57rem; padding: 2px 6px; border-radius: 10px; flex-shrink: 0; }
  .priority-high { background: rgba(255,77,109,0.14); color: var(--critical); border: 1px solid rgba(255,77,109,0.28); }
  .priority-medium { background: rgba(255,209,102,0.14); color: var(--pending-color); border: 1px solid rgba(255,209,102,0.28); }
  .priority-low { background: rgba(79,255,176,0.1); color: var(--accent); border: 1px solid rgba(79,255,176,0.2); }
  .task-del-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.85rem; padding: 0 2px; border-radius: 4px; transition: all 0.15s; flex-shrink: 0; }
  .task-del-btn:hover { color: var(--critical); }
  .add-task-row { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
  .add-task-row input { flex: 1; min-width: 130px; }
  .add-task-row select { width: 96px; flex-shrink: 0; }
  .discharge-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 9px; }
  .discharge-toggle { display: flex; align-items: center; gap: 7px; cursor: pointer; font-size: 0.69rem; color: var(--muted); }
  .toggle-switch { width: 33px; height: 18px; border-radius: 10px; background: var(--border); position: relative; transition: background 0.2s; cursor: pointer; flex-shrink: 0; }
  .toggle-switch.on { background: var(--accent); }
  .toggle-knob { position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; border-radius: 50%; background: white; transition: transform 0.2s; }
  .toggle-switch.on .toggle-knob { transform: translateX(15px); }
  .btn-row { display: flex; gap: 7px; flex-wrap: wrap; }
  .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.72rem; font-weight: 500; transition: opacity 0.15s; display: flex; align-items: center; gap: 5px; }
  .btn-primary { background: var(--accent); color: var(--bg); }
  .btn-primary:hover { opacity: 0.85; }
  .btn-danger { background: rgba(255,77,109,0.14); color: var(--critical); border: 1px solid rgba(255,77,109,0.28); }
  .btn-danger:hover { background: rgba(255,77,109,0.24); }
  .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .confirm-body { padding: 22px; display: flex; flex-direction: column; gap: 16px; }
  .confirm-msg { font-size: 0.8rem; line-height: 1.6; color: var(--muted); }
  .confirm-msg strong { color: var(--text); }
  .form-body { padding: 18px 22px; display: flex; flex-direction: column; gap: 13px; }
  .empty-state { font-size: 0.72rem; color: var(--muted); padding: 8px 0; font-style: italic; }
  .type-row { display: flex; gap: 8px; }
  .type-option { flex: 1; padding: 8px 10px; border-radius: 8px; border: 1.5px solid var(--border); cursor: pointer; text-align: center; font-size: 0.71rem; transition: all 0.15s; color: var(--muted); }
  .type-option.sel-public { border-color: var(--accent); background: rgba(79,255,176,0.07); color: var(--accent); }
  .type-option.sel-private { border-color: var(--private-color); background: rgba(192,132,252,0.07); color: var(--private-color); }
  .scrollbar-thin::-webkit-scrollbar { width: 5px; }
  .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
  .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="logo">Ward<span>Tracker</span></div>
  <div class="header-right">
    <button class="btn-header" onclick="openAddWard()">ï¼‹ Add Ward</button>
    <div class="header-meta">
      <strong id="current-time"></strong>
      <span>Dhrish's Project</span>
    </div>
  </div>
</header>

<main>
  <div class="top-bar">
    <div class="legend">
      <div class="legend-item"><div class="flag flag-pending"></div> Pending tasks</div>
      <div class="legend-item"><div class="flag flag-critical"></div> Critical</div>
      <div class="legend-item"><div class="flag flag-discharge"></div> Discharge ready</div>
      <div class="legend-item"><div class="flag flag-private"></div> Private patient</div>
    </div>
  </div>
  <div class="ward-grid" id="ward-grid"></div>
</main>

<!-- PATIENT MODAL -->
<div class="modal-overlay" id="pat-overlay" onclick="overlayClick(event,'pat-overlay')">
  <div class="modal scrollbar-thin" id="pat-modal">
    <div class="modal-top">
      <div class="modal-title-row">
        <div>
          <div class="modal-patient-name" id="m-name"></div>
          <div class="modal-sub" id="m-sub"></div>
        </div>
        <div id="m-badge"></div>
      </div>
      <div class="modal-top-actions">
        <button class="edit-btn" id="edit-btn" onclick="toggleEdit()">âœŽ Edit</button>
        <button class="close-btn" onclick="closeModal('pat-overlay')">âœ•</button>
      </div>
    </div>
    <div class="modal-body" id="m-body"></div>
  </div>
</div>

<!-- ADD/RENAME WARD MODAL -->
<div class="modal-overlay" id="ward-overlay" onclick="overlayClick(event,'ward-overlay')">
  <div class="modal sm scrollbar-thin">
    <div class="modal-top">
      <div><div class="modal-patient-name" id="ward-modal-title" style="font-size:1.05rem;"></div></div>
      <button class="close-btn" onclick="closeModal('ward-overlay')">âœ•</button>
    </div>
    <div class="form-body">
      <div class="field-group">
        <label class="field-label">Ward Name</label>
        <input type="text" id="ward-name-input" placeholder="e.g. Neurology">
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="ward-confirm-btn"></button>
        <button class="btn btn-ghost" onclick="closeModal('ward-overlay')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD PATIENT MODAL -->
<div class="modal-overlay" id="newpat-overlay" onclick="overlayClick(event,'newpat-overlay')">
  <div class="modal sm scrollbar-thin">
    <div class="modal-top">
      <div>
        <div class="modal-patient-name" style="font-size:1.05rem;">New Patient</div>
        <div class="modal-sub" id="newpat-ward-label"></div>
      </div>
      <button class="close-btn" onclick="closeModal('newpat-overlay')">âœ•</button>
    </div>
    <div class="form-body">
      <div class="field-group"><label class="field-label">Full Name *</label><input type="text" id="np-name" placeholder="e.g. Jane Smith"></div>
      <div class="field-row">
        <div class="field-group"><label class="field-label">Bed</label><input type="text" id="np-bed" placeholder="Bed 3A"></div>
        <div class="field-group"><label class="field-label">Age</label><input type="number" id="np-age" placeholder="45" min="0" max="130"></div>
      </div>
      <div class="field-group">
        <label class="field-label">Gender</label>
        <select id="np-gender"><option value="M">Male</option><option value="F">Female</option><option value="X">Non-binary / Other</option></select>
      </div>
      <div class="field-group">
        <label class="field-label">Patient Type</label>
        <div class="type-row">
          <div class="type-option sel-public" id="np-pub" onclick="npSetType('public')">Public</div>
          <div class="type-option" id="np-priv" onclick="npSetType('private')">Private</div>
        </div>
      </div>
      <div class="field-group"><label class="field-label">Primary Diagnosis</label><input type="text" id="np-diag" placeholder="e.g. Community-Acquired Pneumonia"></div>
      <div class="field-group"><label class="field-label">Clinical Notes</label><textarea class="mta" id="np-notes" rows="3" placeholder="Background, current status..."></textarea></div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="confirmAddPatient()">Add Patient</button>
        <button class="btn btn-ghost" onclick="closeModal('newpat-overlay')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="modal-overlay" id="confirm-overlay" onclick="overlayClick(event,'confirm-overlay')">
  <div class="modal sm scrollbar-thin">
    <div class="modal-top">
      <div><div class="modal-patient-name" style="font-size:1.05rem;color:var(--critical);">Confirm Delete</div></div>
      <button class="close-btn" onclick="closeModal('confirm-overlay')">âœ•</button>
    </div>
    <div class="confirm-body">
      <div class="confirm-msg" id="confirm-msg"></div>
      <div class="btn-row">
        <button class="btn btn-danger" id="confirm-yes">Delete</button>
        <button class="btn btn-ghost" onclick="closeModal('confirm-overlay')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ DATA â”€â”€
let wards = [
  { id:'w1', name:'Cardiology', patients:[
    { id:'p1', name:'Margaret Osei', bed:'Bed 4A', age:67, gender:'F', color:'#ff6b6b', isPrivate:true, critical:true,
      diagnosis:{ primary:'Acute Myocardial Infarction (STEMI)', details:'Admitted 3 days ago following chest pain onset. Troponin elevated at 2.4. PCI performed on Day 1. Currently stable on dual antiplatelet therapy.' },
      tasks:[{id:'t1',text:'Echo review â€” cardiology consult at 14:00',priority:'high',done:false},{id:'t2',text:'Repeat ECG this afternoon',priority:'medium',done:false},{id:'t3',text:'Statin counselling with pharmacy',priority:'low',done:true}],
      dischargeReady:false, dischargeSummary:'' },
    { id:'p2', name:'David Kimura', bed:'Bed 5B', age:54, gender:'M', color:'#4fffb0', isPrivate:false, critical:false,
      diagnosis:{ primary:'Paroxysmal Atrial Fibrillation', details:'Recurrent episodes managed with rate control. Anticoagulation initiated. Holter monitor arranged as outpatient.' },
      tasks:[{id:'t4',text:'Confirm INR result from morning bloods',priority:'medium',done:false}],
      dischargeReady:true, dischargeSummary:'Patient stable. Discharged on bisoprolol 5mg OD and rivaroxaban 20mg OD. GP follow up in 2 weeks. Outpatient Holter arranged.' }
  ]},
  { id:'w2', name:'General Surgery', patients:[
    { id:'p3', name:'Amara Diallo', bed:'Bed 2C', age:34, gender:'F', color:'#ffd166', isPrivate:false, critical:false,
      diagnosis:{ primary:'Acute Appendicitis', details:'Laparoscopic appendicectomy performed yesterday. Uncomplicated. Tolerating clear fluids. Wound sites intact.' },
      tasks:[{id:'t5',text:'Upgrade diet to full fluids',priority:'medium',done:false},{id:'t6',text:'Wound check by surgical nurse',priority:'low',done:false},{id:'t7',text:'Analgesia review â€” step down from IV',priority:'high',done:false}],
      dischargeReady:false, dischargeSummary:'' },
    { id:'p4', name:'Reuben Strauss', bed:'Bed 1A', age:72, gender:'M', color:'#a29bfe', isPrivate:true, critical:true,
      diagnosis:{ primary:'Colorectal Carcinoma â€” Post-op Resection', details:'Right hemicolectomy performed 5 days ago. Recovering well. Pathology pending. Stoma nurse engaged.' },
      tasks:[{id:'t8',text:'Await pathology results â€” chase labs',priority:'high',done:false},{id:'t9',text:'Stoma output diary reviewed?',priority:'medium',done:true},{id:'t10',text:'Oncology referral letter drafted',priority:'medium',done:false}],
      dischargeReady:false, dischargeSummary:'' }
  ]},
  { id:'w3', name:'Respiratory', patients:[
    { id:'p5', name:'Priya Nair', bed:'Bed 7D', age:45, gender:'F', color:'#74b9ff', isPrivate:false, critical:false,
      diagnosis:{ primary:'Community-Acquired Pneumonia', details:'CXR confirmed right lower lobe consolidation. On IV Amoxicillin. O2 sats improving â€” now 96% on 2L. CRP trending down.' },
      tasks:[{id:'t11',text:'Step down to oral antibiotics if sats hold',priority:'medium',done:false},{id:'t12',text:'Repeat bloods tomorrow morning',priority:'low',done:false}],
      dischargeReady:false, dischargeSummary:'' },
    { id:'p6', name:'Frank Balogun', bed:'Bed 8A', age:61, gender:'M', color:'#fd79a8', isPrivate:false, critical:true,
      diagnosis:{ primary:'COPD Exacerbation', details:'Known COPD (Gold Stage III). Presenting with increased sputum and dyspnoea. On nebulised salbutamol, ipratropium, prednisolone.' },
      tasks:[{id:'t13',text:'ABG this afternoon',priority:'high',done:false},{id:'t14',text:'Smoking cessation referral',priority:'low',done:false},{id:'t15',text:'Pulmonary rehab info given to patient?',priority:'low',done:true}],
      dischargeReady:false, dischargeSummary:'' }
  ]},
  { id:'w4', name:'Orthopaedics', patients:[
    { id:'p7', name:'Yuki Tanaka', bed:'Bed 3F', age:79, gender:'F', color:'#55efc4', isPrivate:false, critical:false,
      diagnosis:{ primary:'Neck of Femur Fracture', details:'Intracapsular fracture. Hemiarthroplasty completed 2 days ago. Physiotherapy commenced. DVT prophylaxis on board.' },
      tasks:[{id:'t16',text:'Physio weight-bearing assessment 10:00',priority:'high',done:false},{id:'t17',text:'OT home assessment arranged?',priority:'medium',done:false},{id:'t18',text:'Orthogeriatric review',priority:'medium',done:true}],
      dischargeReady:false, dischargeSummary:'' },
    { id:'p8', name:'Carlos Mendez', bed:'Bed 3B', age:29, gender:'M', color:'#fdcb6e', isPrivate:true, critical:false,
      diagnosis:{ primary:'Tibial Plateau Fracture', details:'Sports injury. ORIF performed. Non-weight bearing. Neurovascular observations stable. Awaiting social package for home.' },
      tasks:[{id:'t19',text:'Social work referral â€” home package',priority:'high',done:false}],
      dischargeReady:true, dischargeSummary:'ORIF right tibial plateau. Non-weight bearing for 6 weeks. Follow-up in fracture clinic at 2 weeks. Crutches provided. Enoxaparin 40mg OD.' }
  ]}
];

let currentPid = null;
let editMode = false;
let addPatientWardId = null;
let npType = 'public';
let editType = null;
let wardModalMode = 'add';
let renameWardId = null;
let idc = 200;
function uid(){ return 'x'+(++idc)+'_'+Date.now(); }

function esc(s){
  if(s==null)return'';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function findPat(pid){
  for(const w of wards){
    const p=w.patients.find(p=>p.id===pid);
    if(p) return {p,w};
  }
  return null;
}

function getInitials(n){
  return n.split(' ').filter(Boolean).map(x=>x[0]).join('').slice(0,2).toUpperCase();
}

// â”€â”€ RENDER â”€â”€
function renderWards(){
  const g=document.getElementById('ward-grid');
  g.innerHTML='';
  wards.forEach(ward=>{
    const c=document.createElement('div');
    c.className='ward-card';
    c.innerHTML=`
      <div class="ward-header">
        <div class="ward-header-left">
          <div class="ward-name">${esc(ward.name)}</div>
          <div class="ward-badge">${ward.patients.length} pt${ward.patients.length!==1?'s':''}</div>
        </div>
        <div class="ward-actions">
          <button class="icon-btn" title="Rename" onclick="openRenameWard('${ward.id}')">âœŽ</button>
          <button class="icon-btn danger" title="Delete ward" onclick="reqDeleteWard('${ward.id}')">ðŸ—‘</button>
        </div>
      </div>
      <div class="patient-list">
        ${ward.patients.map(p=>patRow(p)).join('')}
        <button class="add-patient-btn" onclick="openAddPatient('${ward.id}')">ï¼‹ Add Patient</button>
      </div>
    `;
    g.appendChild(c);
  });
}

function patRow(p){
  const pending=p.tasks.some(t=>!t.done);
  return `
    <div class="patient-row" onclick="openPat('${p.id}')">
      <div class="patient-left">
        <div class="patient-avatar" style="background:${p.color}22;color:${p.color};border:1.5px solid ${p.color}44;">${getInitials(p.name)}</div>
        <div>
          <div class="patient-name">${esc(p.name)}</div>
          <div class="patient-bed">${esc(p.bed)} Â· ${p.age}${p.gender}</div>
        </div>
      </div>
      <div class="patient-right">
        ${p.isPrivate?'<div class="private-badge-sm">Pvt</div>':''}
        <div class="patient-flags">
          ${pending?'<div class="flag flag-pending" title="Pending tasks"></div>':''}
          ${p.critical?'<div class="flag flag-critical" title="Critical"></div>':''}
          ${p.dischargeReady?'<div class="flag flag-discharge" title="Discharge ready"></div>':''}
        </div>
      </div>
    </div>`;
}

// â”€â”€ PATIENT MODAL â”€â”€
function openPat(pid){
  currentPid=pid; editMode=false; editType=null;
  renderPatModal();
  document.getElementById('pat-overlay').classList.add('active');
}

function toggleEdit(){
  if(editMode){
    // save on done
    saveEdits();
  } else {
    editMode=true;
    const {p}=findPat(currentPid);
    editType=p.isPrivate?'private':'public';
    renderPatModal();
  }
}

function renderPatModal(){
  const {p,w}=findPat(currentPid);
  const eb=document.getElementById('edit-btn');
  eb.textContent=editMode?'âœ“ Save':'âœŽ Edit';
  eb.classList.toggle('active',editMode);
  document.getElementById('m-name').textContent=p.name;
  document.getElementById('m-sub').textContent=`${w.name} Â· ${p.bed} Â· Age ${p.age} Â· ${p.gender==='M'?'Male':p.gender==='F'?'Female':'Non-binary'}`;
  document.getElementById('m-badge').innerHTML=p.isPrivate
    ?'<div class="private-badge">Private</div>'
    :'<div class="public-badge">Public</div>';
  document.getElementById('m-body').innerHTML=editMode?editBody(p):viewBody(p);
}

function viewBody(p){
  return `
    <div>
      <div class="section-label">Diagnosis</div>
      <div class="diagnosis-block">
        <div class="diagnosis-primary">${esc(p.diagnosis.primary)}</div>
        <div class="diagnosis-details">${esc(p.diagnosis.details)}</div>
      </div>
    </div>
    <div>
      <div class="section-label">Pending Work</div>
      <div class="task-list" id="vtl">
        ${p.tasks.length===0?'<div class="empty-state">No tasks.</div>':p.tasks.map(t=>`
          <div class="task-item ${t.done?'done':''}" id="vt-${t.id}">
            <div class="task-checkbox" onclick="toggleTask('${t.id}')"></div>
            <div class="task-text">${esc(t.text)}</div>
            <div class="task-priority priority-${t.priority}">${t.priority}</div>
          </div>`).join('')}
      </div>
    </div>
    <div>
      <div class="discharge-header">
        <div class="section-label" style="margin-bottom:0;flex:1;">Discharge Summary</div>
        <div class="discharge-toggle" onclick="toggleDischarge()">
          <span id="dlabel">${p.dischargeReady?'Ready':'Not ready'}</span>
          <div class="toggle-switch ${p.dischargeReady?'on':''}" id="dtoggle"><div class="toggle-knob"></div></div>
        </div>
      </div>
      <textarea class="mta dta" id="dta" ${p.dischargeReady?'':'disabled'} placeholder="Type discharge summary here...">${esc(p.dischargeSummary)}</textarea>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn btn-primary" onclick="saveDischarge()">Save Summary</button>
      </div>
    </div>
    <div>
      <div class="section-label">Danger Zone</div>
      <button class="btn btn-danger" onclick="reqDeletePat('${p.id}')">Remove Patient</button>
    </div>`;
}

function editBody(p){
  const go=(sel)=>['high','medium','low'].map(v=>`<option value="${v}" ${sel===v?'selected':''}>${v}</option>`).join('');
  const wOpts=wards.map(w=>`<option value="${w.id}" ${findPat(currentPid).w.id===w.id?'selected':''}>${esc(w.name)}</option>`).join('');
  return `
    <div>
      <div class="section-label">Patient Details</div>
      <div style="display:flex;flex-direction:column;gap:9px;">
        <div class="field-group"><label class="field-label">Full Name</label><input type="text" id="e-name" value="${esc(p.name)}"></div>
        <div class="field-row">
          <div class="field-group"><label class="field-label">Bed</label><input type="text" id="e-bed" value="${esc(p.bed)}"></div>
          <div class="field-group"><label class="field-label">Age</label><input type="number" id="e-age" value="${p.age}" min="0" max="130"></div>
        </div>
        <div class="field-row">
          <div class="field-group"><label class="field-label">Gender</label>
            <select id="e-gender">
              <option value="M" ${p.gender==='M'?'selected':''}>Male</option>
              <option value="F" ${p.gender==='F'?'selected':''}>Female</option>
              <option value="X" ${p.gender==='X'?'selected':''}>Non-binary</option>
            </select>
          </div>
          <div class="field-group"><label class="field-label">Ward</label><select id="e-ward">${wOpts}</select></div>
        </div>
        <div class="field-group"><label class="field-label">Patient Type</label>
          <div class="type-row">
            <div class="type-option ${editType!=='private'?'sel-public':''}" id="et-pub" onclick="etSetType('public')">Public</div>
            <div class="type-option ${editType==='private'?'sel-private':''}" id="et-priv" onclick="etSetType('private')">Private</div>
          </div>
        </div>
        <div class="field-row">
          <div class="field-group"><label class="field-label">Critical</label>
            <select id="e-crit"><option value="false" ${!p.critical?'selected':''}>No</option><option value="true" ${p.critical?'selected':''}>Yes</option></select>
          </div>
          <div class="field-group"><label class="field-label">Discharge Ready</label>
            <select id="e-dr"><option value="false" ${!p.dischargeReady?'selected':''}>No</option><option value="true" ${p.dischargeReady?'selected':''}>Yes</option></select>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="section-label">Diagnosis</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div class="field-group"><label class="field-label">Primary Diagnosis</label><input type="text" id="e-dp" value="${esc(p.diagnosis.primary)}"></div>
        <div class="field-group"><label class="field-label">Clinical Notes</label><textarea class="mta" id="e-dd" rows="4">${esc(p.diagnosis.details)}</textarea></div>
      </div>
    </div>
    <div>
      <div class="section-label">Pending Work</div>
      <div class="task-list" id="etl">
        ${p.tasks.map(t=>`
          <div class="task-item" id="et-${t.id}">
            <div class="task-checkbox" style="cursor:default;opacity:0.4;"></div>
            <input type="text" value="${esc(t.text)}" style="flex:1;background:transparent;border:none;padding:0;font-size:0.75rem;color:var(--text);outline:none;" onchange="etText('${t.id}',this.value)">
            <select style="width:90px;padding:3px 7px;font-size:0.67rem;" onchange="etPrio('${t.id}',this.value)">${go(t.priority)}</select>
            <button class="task-del-btn" onclick="delTask('${t.id}')">âœ•</button>
          </div>`).join('')}
      </div>
      <div class="add-task-row">
        <input type="text" id="nt-text" placeholder="New task...">
        <select id="nt-prio"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select>
        <button class="btn btn-ghost" style="padding:7px 12px;font-size:0.71rem;" onclick="addTask()">ï¼‹</button>
      </div>
    </div>
    <div>
      <div class="section-label">Discharge Summary</div>
      <textarea class="mta dta" id="e-ds" placeholder="Type discharge summary here...">${esc(p.dischargeSummary)}</textarea>
    </div>`;
}

function etSetType(t){
  editType=t;
  document.getElementById('et-pub').className='type-option '+(t==='public'?'sel-public':'');
  document.getElementById('et-priv').className='type-option '+(t==='private'?'sel-private':'');
}

function etText(tid,v){const {p}=findPat(currentPid);const t=p.tasks.find(t=>t.id===tid);if(t)t.text=v;}
function etPrio(tid,v){const {p}=findPat(currentPid);const t=p.tasks.find(t=>t.id===tid);if(t)t.priority=v;}

function delTask(tid){
  const {p}=findPat(currentPid);
  p.tasks=p.tasks.filter(t=>t.id!==tid);
  document.getElementById('et-'+tid)?.remove();
  renderWards();
}

function addTask(){
  const text=document.getElementById('nt-text').value.trim();
  if(!text)return;
  const prio=document.getElementById('nt-prio').value;
  const {p}=findPat(currentPid);
  const nt={id:uid(),text,priority:prio,done:false};
  p.tasks.push(nt);
  document.getElementById('nt-text').value='';
  const go=(sel)=>['high','medium','low'].map(v=>`<option value="${v}" ${sel===v?'selected':''}>${v}</option>`).join('');
  const div=document.createElement('div');
  div.className='task-item'; div.id='et-'+nt.id;
  div.innerHTML=`
    <div class="task-checkbox" style="cursor:default;opacity:0.4;"></div>
    <input type="text" value="${esc(text)}" style="flex:1;background:transparent;border:none;padding:0;font-size:0.75rem;color:var(--text);outline:none;" onchange="etText('${nt.id}',this.value)">
    <select style="width:90px;padding:3px 7px;font-size:0.67rem;" onchange="etPrio('${nt.id}',this.value)">${go(prio)}</select>
    <button class="task-del-btn" onclick="delTask('${nt.id}')">âœ•</button>`;
  document.getElementById('etl').appendChild(div);
  renderWards();
}

function saveEdits(){
  const {p,w:oldW}=findPat(currentPid);
  const v=id=>document.getElementById(id);
  p.name=v('e-name').value.trim()||p.name;
  p.bed=v('e-bed').value.trim()||p.bed;
  p.age=parseInt(v('e-age').value)||p.age;
  p.gender=v('e-gender').value;
  p.critical=v('e-crit').value==='true';
  p.dischargeReady=v('e-dr').value==='true';
  p.diagnosis.primary=v('e-dp').value.trim()||p.diagnosis.primary;
  p.diagnosis.details=v('e-dd').value;
  p.dischargeSummary=v('e-ds').value;
  if(editType!==null) p.isPrivate=editType==='private';
  const nwid=v('e-ward').value;
  if(nwid!==oldW.id){
    oldW.patients=oldW.patients.filter(pt=>pt.id!==p.id);
    const nw=wards.find(w=>w.id===nwid);
    if(nw) nw.patients.push(p);
  }
  editMode=false; editType=null;
  renderWards(); renderPatModal();
}

// view mode
function toggleTask(tid){
  const {p}=findPat(currentPid);
  const t=p.tasks.find(t=>t.id===tid);
  if(!t)return;
  t.done=!t.done;
  document.getElementById('vt-'+tid)?.classList.toggle('done',t.done);
  renderWards();
}

function toggleDischarge(){
  const {p}=findPat(currentPid);
  p.dischargeReady=!p.dischargeReady;
  document.getElementById('dtoggle').classList.toggle('on',p.dischargeReady);
  document.getElementById('dlabel').textContent=p.dischargeReady?'Ready':'Not ready';
  document.getElementById('dta').disabled=!p.dischargeReady;
  renderWards();
}

function saveDischarge(){
  const {p}=findPat(currentPid);
  p.dischargeSummary=document.getElementById('dta').value;
  const btn=document.querySelector('#m-body .btn-primary');
  const orig=btn.textContent;
  btn.textContent='Saved âœ“';
  setTimeout(()=>{btn.textContent=orig;},1500);
}

// â”€â”€ WARD MODAL â”€â”€
function openAddWard(){
  wardModalMode='add'; renameWardId=null;
  document.getElementById('ward-modal-title').textContent='New Ward';
  document.getElementById('ward-name-input').value='';
  const cb=document.getElementById('ward-confirm-btn');
  cb.textContent='Add Ward'; cb.onclick=doAddWard;
  document.getElementById('ward-overlay').classList.add('active');
}

function openRenameWard(wid){
  wardModalMode='rename'; renameWardId=wid;
  const ward=wards.find(w=>w.id===wid);
  document.getElementById('ward-modal-title').textContent='Rename Ward';
  document.getElementById('ward-name-input').value=ward.name;
  const cb=document.getElementById('ward-confirm-btn');
  cb.textContent='Save'; cb.onclick=doRenameWard;
  document.getElementById('ward-overlay').classList.add('active');
}

function doAddWard(){
  const name=document.getElementById('ward-name-input').value.trim();
  if(!name)return;
  wards.push({id:uid(),name,patients:[]});
  renderWards(); closeModal('ward-overlay');
}

function doRenameWard(){
  const name=document.getElementById('ward-name-input').value.trim();
  if(!name)return;
  const w=wards.find(w=>w.id===renameWardId);
  if(w) w.name=name;
  renderWards(); closeModal('ward-overlay');
}

function reqDeleteWard(wid){
  const w=wards.find(x=>x.id===wid);
  document.getElementById('confirm-msg').innerHTML=`Delete ward <strong>${esc(w.name)}</strong> and all <strong>${w.patients.length}</strong> patient(s)?`;
  document.getElementById('confirm-yes').onclick=()=>{
    wards=wards.filter(x=>x.id!==wid);
    renderWards(); closeModal('confirm-overlay');
  };
  document.getElementById('confirm-overlay').classList.add('active');
}

// â”€â”€ ADD PATIENT â”€â”€
function openAddPatient(wid){
  addPatientWardId=wid; npType='public';
  const w=wards.find(x=>x.id===wid);
  document.getElementById('newpat-ward-label').textContent=w.name;
  ['np-name','np-bed','np-diag','np-notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('np-age').value='';
  document.getElementById('np-gender').value='M';
  npSetType('public');
  document.getElementById('newpat-overlay').classList.add('active');
}

function npSetType(t){
  npType=t;
  document.getElementById('np-pub').className='type-option '+(t==='public'?'sel-public':'');
  document.getElementById('np-priv').className='type-option '+(t==='private'?'sel-private':'');
}

function confirmAddPatient(){
  const name=document.getElementById('np-name').value.trim();
  if(!name){alert('Name required.');return;}
  const colors=['#ff6b6b','#4fffb0','#ffd166','#74b9ff','#a29bfe','#fd79a8','#55efc4','#fdcb6e'];
  const np={
    id:uid(), name,
    bed:document.getElementById('np-bed').value.trim()||'TBC',
    age:parseInt(document.getElementById('np-age').value)||0,
    gender:document.getElementById('np-gender').value,
    color:colors[Math.floor(Math.random()*colors.length)],
    isPrivate:npType==='private', critical:false,
    diagnosis:{primary:document.getElementById('np-diag').value.trim()||'Not specified',details:document.getElementById('np-notes').value.trim()},
    tasks:[], dischargeReady:false, dischargeSummary:''
  };
  const w=wards.find(x=>x.id===addPatientWardId);
  if(w) w.patients.push(np);
  renderWards(); closeModal('newpat-overlay');
}

function reqDeletePat(pid){
  const {p}=findPat(pid);
  document.getElementById('confirm-msg').innerHTML=`Remove <strong>${esc(p.name)}</strong> from the ward list?`;
  document.getElementById('confirm-yes').onclick=()=>{
    for(const w of wards){const i=w.patients.findIndex(x=>x.id===pid);if(i!==-1){w.patients.splice(i,1);break;}}
    renderWards(); closeModal('confirm-overlay'); closeModal('pat-overlay');
  };
  document.getElementById('confirm-overlay').classList.add('active');
}

// â”€â”€ MODAL UTILS â”€â”€
function closeModal(id){
  document.getElementById(id).classList.remove('active');
  if(id==='pat-overlay'){currentPid=null;editMode=false;editType=null;}
}
function overlayClick(e,id){if(e.target===document.getElementById(id))closeModal(id);}
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){['confirm-overlay','newpat-overlay','ward-overlay','pat-overlay'].forEach(id=>closeModal(id));}
});

// â”€â”€ CLOCK â”€â”€
function tick(){
  const now=new Date();
  document.getElementById('current-time').textContent=now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
tick(); setInterval(tick,1000);

renderWards();
</script>
</body>
</html>
